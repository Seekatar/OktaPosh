BeforeAll {
    . (Join-Path $PSScriptRoot '../setup.ps1') -Unit
    $params = @{}
    if ($PSVersionTable.PSVersion.Major -ge 7) {
        $params['Depth'] = 10
    }

    Mock -CommandName Get-OktaAuthorizationServer `
        -ModuleName OktaPosh `
        -MockWith {
            ConvertFrom-Json @params -InputObject '[{"id":"aus3khmzg4MhFZYuh4x7","name":"Test-AS","description":"UI for test","audiences":["https://test/fp-ui"],"issuer":"https://dev-671484.okta.com/oauth2/aus3khmzg4MhFZYuh4x7","issuerMode":"ORG_URL","status":"ACTIVE","created":"2021-06-21T11:33:02.000Z","lastUpdated":"2021-06-21T11:33:02.000Z","credentials":{"signing":{"kid":"VvPxeuzqfEstLJR-vozKrpl0OzRTPhTj-ypnhlZtdaw","rotationMode":"AUTO","lastRotated":"2021-06-21T11:33:02.000Z","nextRotation":"2021-09-19T11:33:02.000Z"}},"_links":{"rotateKey":{"href":"https://dev-671484.okta.com/api/v1/authorizationServers/aus3khmzg4MhFZYuh4x7/credentials/lifecycle/keyRotate","hints":{"allow":["POST"]}},"metadata":[{"name":"oauth-authorization-server","href":"https://dev-671484.okta.com/oauth2/aus3khmzg4MhFZYuh4x7/.well-known/oauth-authorization-server","hints":{"allow":["GET"]}},{"name":"openid-configuration","href":"https://dev-671484.okta.com/oauth2/aus3khmzg4MhFZYuh4x7/.well-known/openid-configuration","hints":{"allow":["GET"]}}],"keys":{"href":"https://dev-671484.okta.com/api/v1/authorizationServers/aus3khmzg4MhFZYuh4x7/credentials/keys","hints":{"allow":["GET"]}},"claims":{"href":"https://dev-671484.okta.com/api/v1/authorizationServers/aus3khmzg4MhFZYuh4x7/claims","hints":{"allow":["GET","POST"]}},"policies":{"href":"https://dev-671484.okta.com/api/v1/authorizationServers/aus3khmzg4MhFZYuh4x7/policies","hints":{"allow":["GET","POST"]}},"self":{"href":"https://dev-671484.okta.com/api/v1/authorizationServers/aus3khmzg4MhFZYuh4x7","hints":{"allow":["GET","DELETE","PUT"]}},"scopes":{"href":"https://dev-671484.okta.com/api/v1/authorizationServers/aus3khmzg4MhFZYuh4x7/scopes","hints":{"allow":["GET","POST"]}},"deactivate":{"href":"https://dev-671484.okta.com/api/v1/authorizationServers/aus3khmzg4MhFZYuh4x7/lifecycle/deactivate","hints":{"allow":["POST"]}}}}]'
        }
    Mock -CommandName Export-OktaAuthorizationServer `
        -ModuleName OktaPosh `
        -MockWith {

        }
    Mock -CommandName Get-OktaApplication `
        -ModuleName OktaPosh `
        -MockWith {
            ConvertFrom-Json @params '[{"id":"0oa3khma4jMjfF1Z34x7","name":"oidc_client","label":"Test-SPA","status":"ACTIVE","lastUpdated":"2021-06-21T11:35:50.000Z","created":"2021-06-21T11:35:50.000Z","accessibility":{"selfService":false,"errorRedirectUrl":null,"loginRedirectUrl":null},"visibility":{"autoSubmitToolbar":false,"hide":{"iOS":true,"web":true},"appLinks":{"oidc_client_link":true}},"features":[],"signOnMode":"OPENID_CONNECT","credentials":{"userNameTemplate":{"template":"${source.login}","type":"BUILT_IN"},"signing":{"kid":"PsO-MfjE4aiqf1MYxq4NNQvqL0xM1uKTO69C059XTEA"},"oauthClient":{"autoKeyRotation":true,"client_id":"0oa3khma4jMjfF1Z34x7","token_endpoint_auth_method":"none"}},"settings":{"app":{},"notifications":{"vpn":{"network":{"connection":"DISABLED"},"message":null,"helpUrl":null}},"oauthClient":{"client_uri":null,"logo_uri":null,"redirect_uris":["https://rbr-qa.prod.aws.test.is.com/dc-ui/implicit/callback"],"post_logout_redirect_uris":["https://rbr-qa.prod.aws.test.is.com/dc-ui"],"response_types":["token","id_token","code"],"grant_types":["implicit","authorization_code"],"initiate_login_uri":"https://rbr-qa.prod.aws.test.is.com/dc-ui","application_type":"browser","consent_method":"REQUIRED","issuer_mode":"ORG_URL","idp_initiated_login":{"mode":"DISABLED","default_scope":[]}}},"_links":{"appLinks":[{"name":"oidc_client_link","href":"https://dev-671484.okta.com/home/oidc_client/0oa3khma4jMjfF1Z34x7/aln177a159h7Zf52X0g8","type":"text/html"}],"groups":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khma4jMjfF1Z34x7/groups"},"logo":[{"name":"medium","href":"https://ok11static.oktacdn.com/assets/img/logos/default.6770228fb0dab49a1695ef440a5279bb.png","type":"image/png"}],"users":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khma4jMjfF1Z34x7/users"},"deactivate":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khma4jMjfF1Z34x7/lifecycle/deactivate"}}},{"id":"0oa3khnfmk9DupJ8v4x7","name":"oidc_client","label":"Test2-SPA","status":"ACTIVE","lastUpdated":"2021-06-21T11:34:09.000Z","created":"2021-06-21T11:34:08.000Z","accessibility":{"selfService":false,"errorRedirectUrl":null,"loginRedirectUrl":null},"visibility":{"autoSubmitToolbar":false,"hide":{"iOS":true,"web":true},"appLinks":{"oidc_client_link":true}},"features":[],"signOnMode":"OPENID_CONNECT","credentials":{"userNameTemplate":{"template":"${source.login}","type":"BUILT_IN"},"signing":{"kid":"PsO-MfjE4aiqf1MYxq4NNQvqL0xM1uKTO69C059XTEA"},"oauthClient":{"autoKeyRotation":true,"client_id":"0oa3khnfmk9DupJ8v4x7","token_endpoint_auth_method":"none"}},"settings":{"app":{},"notifications":{"vpn":{"network":{"connection":"DISABLED"},"message":null,"helpUrl":null}},"oauthClient":{"client_uri":null,"logo_uri":null,"redirect_uris":["https://rbr-qa.prod.aws.test.is.com/fp-ui/implicit/callback"],"post_logout_redirect_uris":["https://rbr-qa.prod.aws.test.is.com/fp-ui"],"response_types":["token","id_token","code"],"grant_types":["implicit","authorization_code"],"initiate_login_uri":"https://test-qa.prod.aws.test.is.com/fp-ui","application_type":"browser","consent_method":"REQUIRED","issuer_mode":"ORG_URL","idp_initiated_login":{"mode":"DISABLED","default_scope":[]}}},"_links":{"appLinks":[{"name":"oidc_client_link","href":"https://dev-671484.okta.com/home/oidc_client/0oa3khnfmk9DupJ8v4x7/aln177a159h7Zf52X0g8","type":"text/html"}],"groups":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khnfmk9DupJ8v4x7/groups"},"logo":[{"name":"medium","href":"https://ok11static.oktacdn.com/assets/img/logos/default.6770228fb0dab49a1695ef440a5279bb.png","type":"image/png"}],"users":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khnfmk9DupJ8v4x7/users"},"deactivate":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khnfmk9DupJ8v4x7/lifecycle/deactivate"}}}]'
        }
    Mock -CommandName Get-OktaGroup `
        -ModuleName OktaPosh `
        -MockWith {
            ConvertFrom-Json @params @"
            [{"id":"00g3j3wnv5aai0WGH4x7","created":"2021-06-17T13:27:28.000Z","lastUpdated":"2021-06-17T13:27:28.000Z","lastMembershipUpdated":"2021-06-17T13:27:28.000Z","objectClass":["okta:user_group"],"type":"OKTA_GROUP","profile":{"name":"CCC-DataCapture-Client-usaa-Group","description":"Added by OktaPosh"},"_links":{"logo":[{"name":"medium","href":"https://ok11static.oktacdn.com/assets/img/logos/groups/odyssey/okta-medium.1a5ebe44c4244fb796c235d86b47e3bb.png","type":"image/png"},{"name":"large","href":"https://ok11static.oktacdn.com/assets/img/logos/groups/odyssey/okta-large.d9cfbd8a00a4feac1aa5612ba02e99c0.png","type":"image/png"}],"users":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3j3wnv5aai0WGH4x7/users"},"apps":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3j3wnv5aai0WGH4x7/apps"}}},
            {"id":"00g3j3txxpK0j81VK4x7","created":"2021-06-17T13:27:26.000Z","lastUpdated":"2021-06-17T13:27:26.000Z","lastMembershipUpdated":"2021-06-17T13:27:26.000Z","objectClass":["okta:user_group"],"type":"OKTA_GROUP","profile":{"name":"CCC-DataCapture-Client-safeco-Group","description":"Added by OktaPosh"},"_links":{"logo":[{"name":"medium","href":"https://ok11static.oktacdn.com/assets/img/logos/groups/odyssey/okta-medium.1a5ebe44c4244fb796c235d86b47e3bb.png","type":"image/png"},{"name":"large","href":"https://ok11static.oktacdn.com/assets/img/logos/groups/odyssey/okta-large.d9cfbd8a00a4feac1aa5612ba02e99c0.png","type":"image/png"}],"users":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3j3txxpK0j81VK4x7/users"},"apps":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3j3txxpK0j81VK4x7/apps"}}},
            {"id":"00g3j3v3hiOBY8rSD4x7","created":"2021-06-17T13:27:26.000Z","lastUpdated":"2021-06-17T13:27:26.000Z","lastMembershipUpdated":"2021-06-17T13:27:26.000Z","objectClass":["okta:user_group"],"type":"OKTA_GROUP","profile":{"name":"CCC-DataCapture-Client-nw-Group","description":"Added by OktaPosh"},"_links":{"logo":[{"name":"medium","href":"https://ok11static.oktacdn.com/assets/img/logos/groups/odyssey/okta-medium.1a5ebe44c4244fb796c235d86b47e3bb.png","type":"image/png"},{"name":"large","href":"https://ok11static.oktacdn.com/assets/img/logos/groups/odyssey/okta-large.d9cfbd8a00a4feac1aa5612ba02e99c0.png","type":"image/png"}],"users":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3j3v3hiOBY8rSD4x7/users"},"apps":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3j3v3hiOBY8rSD4x7/apps"}}},
            {"id":"00g3j3u80w9crUOpm4x7","created":"2021-06-17T13:27:26.000Z","lastUpdated":"2021-06-17T13:27:26.000Z","lastMembershipUpdated":"2021-06-17T13:27:26.000Z","objectClass":["okta:user_group"],"type":"OKTA_GROUP","profile":{"name":"CCC-DataCapture-Client-geico-Group","description":"Added by OktaPosh"},"_links":{"logo":[{"name":"medium","href":"https://ok11static.oktacdn.com/assets/img/logos/groups/odyssey/okta-medium.1a5ebe44c4244fb796c235d86b47e3bb.png","type":"image/png"},{"name":"large","href":"https://ok11static.oktacdn.com/assets/img/logos/groups/odyssey/okta-large.d9cfbd8a00a4feac1aa5612ba02e99c0.png","type":"image/png"}],"users":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3j3u80w9crUOpm4x7/users"},"apps":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3j3u80w9crUOpm4x7/apps"}}},
            {"id":"00g3jgd74bLQyXHDn4x7","created":"2021-06-17T23:17:28.000Z","lastUpdated":"2021-06-17T23:17:28.000Z","lastMembershipUpdated":"2021-06-23T13:34:55.000Z","objectClass":["okta:user_group"],"type":"OKTA_GROUP","profile":{"name":"CCC-DataCapture-Client-den1-Group","description":"Added by OktaPosh"},"_links":{"logo":[{"name":"medium","href":"https://ok11static.oktacdn.com/assets/img/logos/groups/odyssey/okta-medium.1a5ebe44c4244fb796c235d86b47e3bb.png","type":"image/png"},{"name":"large","href":"https://ok11static.oktacdn.com/assets/img/logos/groups/odyssey/okta-large.d9cfbd8a00a4feac1aa5612ba02e99c0.png","type":"image/png"}],"users":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3jgd74bLQyXHDn4x7/users"},"apps":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3jgd74bLQyXHDn4x7/apps"}}}]
"@
        }
    Mock -CommandName Get-OktaApplicationGroup `
        -ModuleName OktaPosh `
        -MockWith {
            ConvertFrom-Json @params '[{"id":"00g3j3wnv5aai0WGH4x7","lastUpdated":"2021-06-21T11:35:53.000Z","priority":0,"profile":{},"_links":{"app":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khma4jMjfF1Z34x7"},"self":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khma4jMjfF1Z34x7/groups/00g3j3wnv5aai0WGH4x7"},"group":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3j3wnv5aai0WGH4x7"}}},{"id":"00g3j3txxpK0j81VK4x7","lastUpdated":"2021-06-21T11:35:53.000Z","priority":1,"profile":{},"_links":{"app":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khma4jMjfF1Z34x7"},"self":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khma4jMjfF1Z34x7/groups/00g3j3txxpK0j81VK4x7"},"group":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3j3txxpK0j81VK4x7"}}},{"id":"00g3j3v3hiOBY8rSD4x7","lastUpdated":"2021-06-21T11:35:52.000Z","priority":2,"profile":{},"_links":{"app":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khma4jMjfF1Z34x7"},"self":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khma4jMjfF1Z34x7/groups/00g3j3v3hiOBY8rSD4x7"},"group":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3j3v3hiOBY8rSD4x7"}}},{"id":"00g3j3u80w9crUOpm4x7","lastUpdated":"2021-06-21T11:35:52.000Z","priority":3,"profile":{},"_links":{"app":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khma4jMjfF1Z34x7"},"self":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khma4jMjfF1Z34x7/groups/00g3j3u80w9crUOpm4x7"},"group":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3j3u80w9crUOpm4x7"}}},{"id":"00g3jgd74bLQyXHDn4x7","lastUpdated":"2021-06-21T11:35:52.000Z","priority":4,"profile":{},"_links":{"app":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khma4jMjfF1Z34x7"},"self":{"href":"https://dev-671484.okta.com/api/v1/apps/0oa3khma4jMjfF1Z34x7/groups/00g3jgd74bLQyXHDn4x7"},"group":{"href":"https://dev-671484.okta.com/api/v1/groups/00g3jgd74bLQyXHDn4x7"}}}]'
        }
    Mock -CommandName Get-OktaTrustedOrigin `
        -ModuleName OktaPosh `
        -MockWith {
            ConvertFrom-Json @params '[{"id":"tos3j3t9h0xydEAvU4x7","name":"https://test-ct.test.portal.com","origin":"https://test-ct.test.portal.com","scopes":[{"type":"CORS"},{"type":"REDIRECT"}],"status":"ACTIVE","created":"2021-06-17T13:27:34.000Z","createdBy":"00uo7rvykPMZxtjpU4x6","lastUpdated":"2021-06-17T13:27:34.000Z","lastUpdatedBy":"00uo7rvykPMZxtjpU4x6","_links":{"self":{"href":"https://dev-671484.okta.com/api/v1/trustedOrigins/tos3j3t9h0xydEAvU4x7","hints":{"allow":["GET","PUT","DELETE"]}},"deactivate":{"href":"https://dev-671484.okta.com/api/v1/trustedOrigins/tos3j3t9h0xydEAvU4x7/lifecycle/deactivate","hints":{"allow":["POST"]}}}},{"id":"tos3j3vnfgxX2q8Jm4x7","name":"https://test-CT.prod.aws.test.is.com","origin":"https://test-CT.prod.aws.test.is.com","scopes":[{"type":"CORS"},{"type":"REDIRECT"}],"status":"ACTIVE","created":"2021-06-17T13:27:33.000Z","createdBy":"00uo7rvykPMZxtjpU4x6","lastUpdated":"2021-06-17T13:27:33.000Z","lastUpdatedBy":"00uo7rvykPMZxtjpU4x6","_links":{"self":{"href":"https://dev-671484.okta.com/api/v1/trustedOrigins/tos3j3vnfgxX2q8Jm4x7","hints":{"allow":["GET","PUT","DELETE"]}},"deactivate":{"href":"https://dev-671484.okta.com/api/v1/trustedOrigins/tos3j3vnfgxX2q8Jm4x7/lifecycle/deactivate","hints":{"allow":["POST"]}}}},{"id":"tos3khnss0iz370B64x7","name":"https://test-qa.prod.aws.test.is.com","origin":"https://test-qa.prod.aws.test.is.com","scopes":[{"type":"CORS"},{"type":"REDIRECT"}],"status":"ACTIVE","created":"2021-06-21T11:35:18.000Z","createdBy":"00uo7rvykPMZxtjpU4x6","lastUpdated":"2021-06-21T11:35:18.000Z","lastUpdatedBy":"00uo7rvykPMZxtjpU4x6","_links":{"self":{"href":"https://dev-671484.okta.com/api/v1/trustedOrigins/tos3khnss0iz370B64x7","hints":{"allow":["GET","PUT","DELETE"]}},"deactivate":{"href":"https://dev-671484.okta.com/api/v1/trustedOrigins/tos3khnss0iz370B64x7/lifecycle/deactivate","hints":{"allow":["POST"]}}}}]'
        }

}

Describe "Yaml tests" {
    It "Tests Get-OktaLog" {
        Push-Location (Join-Path $PSScriptRoot mock-auth-export)
        ConvertTo-OktaYaml -OutputFolder (Join-Path $PSScriptRoot mock-auth-export) -AuthServerQuery test -ApplicationQuery test -GroupQueries test
        Test-Path app-Test-SPA.yaml | Should -BeTrue
        Test-Path app-Test2-SPA.yaml | Should -BeTrue
        Test-Path trustedOrigins.yaml | Should -BeTrue
        Test-Path ./Test-AS/auth.yaml | Should -BeTrue
    }
    It "CleansUp" {
        Pop-Location
        Get-ChildItem (Join-Path $PSScriptRoot mock-auth-export/*.yaml) -Recurse | Remove-Item -Force -ErrorAction Ignore
    }
}
